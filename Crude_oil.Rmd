---
title: "Crude Oil Analysis"
author: "Kevin Bonds"
date: "10/29/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following is an analysis of crude oil data. There are many factors that come into play to influence the prices of petroleum products. An exhaustive study would take some time, but we can gain some insights and prepare for deeper analysis quite quickly. 

The first thing to do is to load the libraries needed

```{r message=FALSE, warning=FALSE, error=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(zoo)
library(knitr)
```

## Load the data

The xls file can be downloaded from: https://www.eia.gov/dnav/pet/PET_PRI_SPT_S1_M.htm. The series history can be loaded by selecting the excel icon. Let's quickly create a csv called _spot_crude.csv_ of just the first data tab. We will load all tabs, from the xls directly, in a later step. Now let's load the csv into R to start formatting. 

```{r load_csv, message=FALSE, warning=FALSE}
# Quickly read in WTI crude oil from csv
wti_crude_spot <- read_csv("spot_crude.csv")
wti_crude_spot <- wti_crude_spot %>% 
        select(1:3) 
head(wti_crude_spot)
```

## Formatting and adding MoM and YoY

The Tidyverse has some great functions. One of them is the _lag()_ function. It allows you to lag or offset some number of records that you specify. I used the default 1 for MoM and 12 for YoY (as seen below). The data is already sorted. 

I also pulled out _Month_ and _Year_ to make it a little simpler to join on later. 

```{r first_df}
# Create a clean df with MoM and YoY for just Crude Oil
wti_crude_spot <- wti_crude_spot %>% 
        mutate("Date2" = as.Date(as.yearmon(Date, "%b-%Y"), frac = 1),
               "Month" = month(Date2),
               "Year" = year(Date2),
               "MoM_crude_oil" = 
                       (`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)` - 
                                lag(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`))/ 
                       lag(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`),
               "YoY_crude_oil" = 
                       (`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)` - 
                                lag(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`, 12))/ 
                       lag(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`, 12))

kable(wti_crude_spot[12:17,], caption= "Table with MoM and YoY")
```

## Calculate some yearly stats

We can also quickly calculate some yearly stats and join them back to the original table. This may come in handy as features for a model. It's quick and easy so let's go ahead and do that now.

```{r yearly_stats, message=FALSE, warning=FALSE}
# Calculate yearly stats
year_stats <- wti_crude_spot %>% 
        group_by(Year) %>% 
        summarize( "yr_mean_crude" = mean(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`),
                   "yr_median_crude" = median(`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`))
# Join to larger dataframe
wti_crude_spot <- left_join(wti_crude_spot, year_stats, on = c("Year" = "Year"))
kable(wti_crude_spot[12:17,], caption= "Table with Yearly Stats")
```

## Loading the rest of the data from the xlsx

I want to read each tab of the xlsx file into it's own data frame to allow specifying column types--since the tabs differ in format a bit. They all have a few rows that need to be skipped so let's do that as we read them in.

```{r rest_of_data, warning=FALSE, message=FALSE}
# Read rest of data directly from xlsx file into tables
raw_data_path <- "raw_data_sheet.xlsx"
sheets <- raw_data_path %>%
        excel_sheets() %>% 
        set_names()

conv_gasoline <- read_excel(raw_data_path, sheet = sheets[3], skip = 2, col_types = c("date", "numeric", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

RBOB_gasoline <- read_excel(raw_data_path, sheet = sheets[4], skip = 2, col_types = c("date", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

heating_oil <- read_excel(raw_data_path, sheet = sheets[5], skip = 2, col_types = c("date", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

uls_diesel <- read_excel(raw_data_path, sheet = sheets[6], skip = 2, col_types = c("date", "numeric", "numeric", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

jet <- read_excel(raw_data_path, sheet = sheets[7], skip = 2, col_types = c("date", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))
propane <- read_excel(raw_data_path, sheet = sheets[8], skip = 2, col_types = c("date", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

```

## Join Together

Now that we have data frames for the various gasoline and heating oil, etc. let's join them all into a new data frame. And also, clean and organize the resulting table a bit.

```{r join_all, warning=FALSE, message=FALSE}
# Join conv_gasoline and heating_oil
energy_df <- left_join(wti_crude_spot, conv_gasoline[,2:5], on = c("Year" = "Year", "Month" = "Month")) %>% 
        left_join(heating_oil[,2:4], on = c("Year" = "Year", "Month" = "Month")) %>%
        left_join(uls_diesel[-1], on = c("Year" = "Year", "Month" = "Month")) %>% 
        left_join(RBOB_gasoline[-1], on = c("Year" = "Year", "Month" = "Month")) %>% 
        left_join(jet[-1], on = c("Year" = "Year", "Month" = "Month")) %>% 
        left_join(propane[-1], on = c("Year" = "Year", "Month" = "Month"))

energy_df <- energy_df %>% select("Date"= `Date2`, c(5:6, 2:3, 7:length(energy_df)))
head(energy_df)
```

Now we have a nice single data frame with `r length(energy_df)` columns pertaining to our summary statistics as well as some other petroleum prices. 

## All the Variables
Now we have quite a bit of data loaded into one nice data frame, but not much along the lines of outside influences to explain the changes in crude oil prices. One thing, I can think of, might be US oil production levels. Let's grab that data and join it in.

```{r production_levels, message=FALSE, warning=FALSE}
# Add US crude oil production form https://www.eia.gov/dnav/pet/hist/LeafHandler.ashx?n=PET&s=MCRFPUS1&f=M
US_crude_prod <- read_excel("US_crude_prod.xls", sheet = sheets[2], skip = 2, col_types = c("date", "numeric")) %>% 
        mutate("Month" = month(Date), "Year" = year(Date))

energy_df <- left_join(energy_df, US_crude_prod[-1], on = c("Year" = "Year", "Month" = "Month"))
```
## Now we can start looking at the data

Let's create some time series objects and plot them

```{r ts_plots, fig.height=10}
# Create time series objects for WTI Spot and Field Production
cop <-  ts(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`, start= c(1986,1), end = c(2019,8), frequency = 12)
prod_cude <-  ts(energy_df$`U.S. Field Production of Crude Oil (Thousand Barrels)`, start= c(1986,1), end = c(2019,8), frequency = 12)
par(mfrow=c(2,1))
# Plot them one on top of the other
plot(cop, type = "o", ylab = "Price", main = "Fig. 1 - Time series plot for Crude oil price")
plot(prod_cude, type = "o", ylab = "Monthly Barrels", main = "Fig. 2 - Time series plot for US Crude Oil Production")

```

Obviously we have some inflation impact to consider but, we can see there has been quite a bit of volatility even considering monthly averages. Just looking at these plots doesn't suggest a nice correlation. But since we haven't yet accounted for inflation, let's quickly look to see how correlated these data are over more recent data.

```{r cor_production}
# Jan-2013 to July-2019
cor(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`[325:403], energy_df$`U.S. Field Production of Crude Oil (Thousand Barrels)`[325:403])
# Feb-2015 to July-2019
cor(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`[350:403], energy_df$`U.S. Field Production of Crude Oil (Thousand Barrels)`[350:403])
# Jan-2016 to July-2019
cor(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`[361:403], energy_df$`U.S. Field Production of Crude Oil (Thousand Barrels)`[361:403])

```
It does seem that as we take more near-term data the correlation is a bit stronger. From above you can see that taking Jan/2016-July/2019 the data and calculating the correlation coefficient we get 0.62 meaning a fairly strong, positive correlation--as 1.0 would be data perfectly moving in relation to each other. Maybe if we adjusted for inflation things look even better here. We could use CPI and adjust the numbers we have or find some already adjusted perhaps. But for now, we can check to see where the max price, min price, max MoM and min MoM (which would be the max decrease) to give us a sense of when these maximums and minimums occurred. 

```{r}
# Max crude oil price
energy_df[which.max(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`),][c(1,4)]

# Min crude oil price
energy_df[which.min(energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`),][c(1,4)]

# Max MoM
energy_df[which.max(energy_df$MoM_crude_oil),][c(1,6)]

# min MoM
energy_df[which.min(energy_df$MoM_crude_oil),][c(1,6)]
```

```{r}
# Max MoM
energy_df[which.max(energy_df$MoM_crude_oil),][c(1,6)]
```




 

## Extra Credit

One of our extra credit questions is how correlated is the US Gulf Coast Conventional Gasoline Spot price with the New York Harbor Conventional Gasoline Regular Spot Price. This is easily calculated using the _cor()_ base function in R.

```{r}
# How tightly correlated is Gulf Coast Spot prices vs New York Harbor?
cor(energy_df$`U.S. Gulf Coast Conventional Gasoline Regular Spot Price FOB (Dollars per Gallon)`[6:405], energy_df$`New York Harbor Conventional Gasoline Regular Spot Price FOB (Dollars per Gallon)`[6:405])
```

I'm also curious about the crude oil price vs gasoline price? So let's calculate the correlation for Cushing, OK WTI Spot Price vs. US Gulf Coast Conventional Gasoline Regular Spot Price.


```{r}
# How tightly correlated is Gulf Coast Spot prices vs Cushing, OK WTI?
cor(energy_df$`U.S. Gulf Coast Conventional Gasoline Regular Spot Price FOB (Dollars per Gallon)`[6:405], energy_df$`Cushing, OK WTI Spot Price FOB (Dollars per Barrel)`[6:405])
```
Both of these are very tightly correlated as one might expect. At least at the monthly average level.

# Timeboxed Summary

So we have created a nice table and identified the need for more influential data. We brought in US oil production data, to help, and calculated the correlation coefficient to understand how tightly these move together. We determined that they are only somewhat correlated. Also, we found the dates at which 4 maximum or minimum events happened. Also, we saw from a simple plot that crude oil prices have experience very rapid changes. We calculated the Month-over-Month and Year-over-Year to help identify when this change was most rapid and possible help with modeling.

## Next steps

Some next steps would be to adjust our prices for inflation; try fitting a linear model using the features we have; Do some investigating around seasonality